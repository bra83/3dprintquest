<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1f2416">
    <title>333 Print Quest</title>
    
    <!-- ================================================================== -->
    <!-- üì± CONFIGURA√á√ÉO PWA & √çCONES (APP NATIVO) -->
    <!-- ================================================================== -->
    
    <!-- √çcone SVG desenhado "na m√£o" para garantir que n√£o dependa de links externos -->
    <script>
        // √çcone: Fundo Verde Zelda, Borda Dourada, Espada Pixelada no meio
        const iconSVG = `
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512">
            <rect x="0" y="0" width="512" height="512" rx="100" fill="#1f2416" stroke="#f8d878" stroke-width="20"/>
            <path d="M246 100 L266 100 L266 300 L300 300 L300 330 L266 330 L266 400 L246 400 L246 330 L212 330 L212 300 L246 300 Z" fill="#c0c0c0"/>
            <path d="M256 100 L280 150 L232 150 Z" fill="#f8d878"/>
            <rect x="246" y="150" width="20" height="150" fill="#a0a0a0"/>
            <rect x="212" y="300" width="88" height="30" fill="#3b82f6" stroke="#000" stroke-width="5"/>
            <circle cx="256" cy="315" r="8" fill="#f8d878"/>
        </svg>`;
        
        const iconUrl = "data:image/svg+xml;base64," + btoa(iconSVG);

        const manifest = {
            "name": "333 Print Quest",
            "short_name": "PrintQuest",
            "start_url": ".",
            "display": "standalone",
            "background_color": "#1f2416",
            "theme_color": "#1f2416",
            "orientation": "portrait",
            "icons": [
                {
                    "src": iconUrl,
                    "sizes": "192x192 512x512",
                    "type": "image/svg+xml",
                    "purpose": "any maskable" 
                }
            ]
        };
        
        // Injeta o manifesto dinamicamente
        const blob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        const manifestURL = URL.createObjectURL(blob);
        document.write(`<link rel="manifest" href="${manifestURL}">`);
        document.write(`<link rel="icon" type="image/svg+xml" href="${iconUrl}">`);
        document.write(`<link rel="apple-touch-icon" href="${iconUrl}">`);
    </script>

    <!-- Meta Tags para iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Print Quest">

    <!-- 1. FERRAMENTAS (CDN) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 2. √çCONES LUCIDE -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/lucide-react@latest/dist/umd/lucide-react.js"></script>

    <!-- 3. FONTES RETRO -->
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">

    <!-- 4. ESTILOS -->
    <style>
        :root {
            --zelda-bg: #1f2416;         
            --zelda-gold: #f8d878;       
            --zelda-green: #00a800;      
            --zelda-brown: #603813;      
            --zelda-paper: #fcf0c8;      
            --zelda-red: #e60012;        
        }

        body { 
            background-color: var(--zelda-bg); 
            margin: 0; 
            font-family: 'VT323', monospace; 
            color: var(--zelda-paper);
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none;
        }
        
        .font-retro { font-family: 'Press Start 2P', cursive; }
        .font-term { font-family: 'VT323', monospace; }
        
        .retro-box { 
            background-color: var(--zelda-paper); 
            border: 4px solid var(--zelda-brown); 
            box-shadow: 4px 4px 0px #000; 
            image-rendering: pixelated; 
            color: #2c1a0b;
            border-radius: 4px;
        }
        
        .retro-btn { 
            transition: all 0.1s; 
            box-shadow: 3px 3px 0px #000; 
            border: 2px solid #fff; 
            cursor: pointer;
            text-shadow: 1px 1px 0 #000;
        }
        .retro-btn:active { transform: translate(2px, 2px); box-shadow: 1px 1px 0px #000; }
        .retro-btn:disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(1); }
        
        .retro-input { 
            background-color: #fff; 
            border: 2px solid var(--zelda-brown); 
            font-family: 'VT323', monospace; 
            font-size: 1.3rem; 
            color: #000; 
            padding: 0.2rem 0.5rem; 
            border-radius: 2px;
        }

        /* Cores de Bot√£o */
        .btn-green { background-color: var(--zelda-green); color: white; }
        .btn-red { background-color: var(--zelda-red); color: white; }
        .btn-blue { background-color: #0078d7; color: white; }
        .btn-gold { background-color: var(--zelda-gold); color: #603813; text-shadow: none; border-color: #603813; }

        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        .blink { animation: blink 1s infinite; }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--zelda-bg); }
        ::-webkit-scrollbar-thumb { background: var(--zelda-gold); border: 1px solid var(--zelda-brown); border-radius: 4px; }
        
        #error-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #800000; color: white; padding: 2rem; z-index: 9999; font-family: monospace; }
        
        header { padding-top: env(safe-area-inset-top); }
        main { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body>
    <div id="root"></div>
    <div id="error-overlay">
        <h1 style="font-size: 2rem; margin-bottom: 1rem;">GAME OVER</h1>
        <p>333 Print Quest encontrou um problema cr√≠tico.</p>
        <pre id="error-message" style="margin-top: 1rem; color: #ffff00; white-space: pre-wrap;"></pre>
        <button onclick="window.location.reload()" style="margin-top: 2rem; padding: 10px 20px; background: white; color: black; border: none; cursor: pointer; font-weight: bold;">TRY AGAIN</button>
    </div>

    <script>
        window.onerror = function(message, source, lineno, colno, error) {
            document.getElementById('root').style.display = 'none';
            document.getElementById('error-overlay').style.display = 'block';
            document.getElementById('error-message').textContent = `MSG: ${message}\nSRC: ${source}:${lineno}\nSTACK: ${error ? error.stack : 'N/A'}`;
        };
    </script>

    <script type="text/babel">
        
        const { useState, useEffect } = React;
        
        // √çCONES EMBUTIDOS
        const IconBase = ({ children, size = 24, className = "" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );

        const Icons = {
            Sword: (p) => <IconBase {...p}><path d="M14.5 17.5L3 6V3h3l11.5 11.5"/><path d="m13 19 6-6"/><path d="M16 16 4 4"/><path d="M19 21 7 9"/></IconBase>,
            Scroll: (p) => <IconBase {...p}><path d="M8 2h2v4H8z"/><path d="M19 17V5a2 2 0 0 0-2-2H4"/><path d="M8 21h12a2 2 0 0 0 2-2v-1a1 1 0 0 0-1-1H11a1 1 0 0 0-1 1v2a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/></IconBase>,
            Coins: (p) => <IconBase {...p}><circle cx="8" cy="8" r="6"/><path d="M18.09 10.37A6 6 0 1 1 10.34 18"/><path d="M7 6h1v4"/><path d="m16.71 13.88.7 .71-2.82 2.82"/></IconBase>,
            Hammer: (p) => <IconBase {...p}><path d="m15 12-8.5 8.5c-.83.83-2.17.83-3 0 0 0 0 0 0 0a2.12 2.12 0 0 1 0-3L12 9"/><path d="M17.64 15 22 10.64"/><path d="m20.91 11.7-1.25-1.25c-.6-.6-.93-1.4-.93-2.25V7.86c0-.55-.45-1-1-1H16.4c-.84 0-1.65-.33-2.25-.93L12.9 4.65"/></IconBase>,
            Settings: (p) => <IconBase {...p}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></IconBase>,
            Package: (p) => <IconBase {...p}><path d="m7.5 4.27 9 5.15"/><path d="M21 8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16Z"/><path d="m3.3 7 8.7 5 8.7-5"/><path d="M12 22v-9"/></IconBase>,
            Ghost: (p) => <IconBase {...p}><path d="M9 10h.01"/><path d="M15 10h.01"/><path d="M12 2a8 8 0 0 0-8 8v12l3-3 2.5 2.5L12 19l2.5 2.5L17 19l3 3V10a8 8 0 0 0-8-8z"/></IconBase>,
            RefreshCw: (p) => <IconBase {...p}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconBase>,
            AlertTriangle: (p) => <IconBase {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></IconBase>,
            Save: (p) => <IconBase {...p}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>,
            PlusCircle: (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="16"/><line x1="8" y1="12" x2="16" y2="12"/></IconBase>,
            TrendingUp: (p) => <IconBase {...p}><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></IconBase>,
            Calendar: (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></IconBase>,
            Trash2: (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></IconBase>,
            Edit3: (p) => <IconBase {...p}><path d="M12 20h9"/><path d="M16.5 3.5a2.12 2.12 0 0 1 3 3L7 19l-4 1 1-4Z"/></IconBase>,
            Droplet: (p) => <IconBase {...p}><path d="M12 22a7 7 0 0 0 7-7c0-2-1-3.9-3-5.5s-3.5-4-4-6.5c-.5 2.5-2 4.9-4 6.5C6 11.1 5 13 5 15a7 7 0 0 0 7 7z"/></IconBase>,
            X: (p) => <IconBase {...p}><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></IconBase>,
            Menu: (p) => <IconBase {...p}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></IconBase>,
            Download: (p) => <IconBase {...p}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></IconBase>
        };

        // üîó LINK DA API
        const API_URL = "https://script.google.com/macros/s/AKfycbwjMSC1pSgcvdo-C95fqiCw8WBJHAtlbZ2cFjqX0dd-7hncpzICEjSvY0W0CCAQBMvZ/exec";

        // --- HELPERS ---
        const getMoneyVal = (obj, possibleKeys) => {
            if (!obj) return 0;
            let rawVal = undefined;
            for (let k of possibleKeys) {
                if (obj[k] !== undefined) { rawVal = obj[k]; break; }
                if (obj[k.toLowerCase()] !== undefined) { rawVal = obj[k.toLowerCase()]; break; }
                const normK = k.toLowerCase().replace(/_/g, ''); 
                if (obj[normK] !== undefined) { rawVal = obj[normK]; break; }
            }
            if (rawVal === undefined || rawVal === "") return 0;
            if (typeof rawVal === 'number') return rawVal;
            let cleanStr = String(rawVal).replace(/[^\d.,-]/g, "");
            if (cleanStr.includes(',') && cleanStr.includes('.')) cleanStr = cleanStr.replace(/\./g, '').replace(',', '.');
            else if (cleanStr.includes(',')) cleanStr = cleanStr.replace(',', '.');
            const finalNum = parseFloat(cleanStr);
            return isNaN(finalNum) ? 0 : finalNum;
        };

        const getStringVal = (obj, possibleKeys) => {
            if (!obj) return "";
            for (let k of possibleKeys) {
                if (obj[k]) return String(obj[k]);
                if (obj[k.toLowerCase()]) return String(obj[k.toLowerCase()]);
                const normK = k.toLowerCase().replace(/_/g, '');
                if (obj[normK]) return String(obj[normK]);
            }
            return "";
        };

        // --- DADOS OFFLINE ---
        const DB_OFFLINE = {
            config: { custos_fixos_mensais: 800, horas_operacionais_mes: 160, custo_kwh: 0.95, taxa_falha_media: 0.10, custo_hora_humana: 25 },
            maquinas: [{ id: 'P1', nome: 'OFFLINE MK1', potencia_w: 350, preco_compra: 3500, vida_util_h: 10000, custo_manutencao_ano: 200 }],
            materiais: [{ id: 'F1', marca: 'VOOLT', tipo: 'PLA', cor: 'PRETO', hex: '#1a1a1a', pesoinicial: 1000, pesoatual: 850, precokg: 68.00 }],
            insumos: [{ id: 'I1', item: 'BOX', custo_unit: 2.00 }],
            marketplaces: [{ id: 'M1', nome: 'LOCAL', comissao: 0, taxa_fixa_r$: 0, imposto_nota: 0 }],
            historico_gastos: [],
            historico_vendas: []
        };

        // --- COMPONENTES VISUAIS ---
        const RetroCard = ({ title, children, color = "border-[#603813]", icon, extra }) => (
            <div className={`retro-box p-4 mb-6 relative transition-all`}>
                <div className="flex justify-between items-center mb-2 pb-2" style={{borderBottom: '2px solid #60381340'}}>
                    <div className="font-retro text-xs md:text-sm text-[#603813] uppercase flex items-center gap-2">
                        {icon} {title}
                    </div>
                    <div className="flex gap-1">
                        {extra}
                    </div>
                </div>
                {children}
            </div>
        );

        // --- GAUGE DE CARRETEL (ZELDA STYLE) ---
        const SpoolGauge = ({ hex = "#333", current, total }) => {
            const safeTotal = total > 0 ? total : 1000;
            const percentage = Math.min(100, Math.max(0, (current / safeTotal) * 100));
            const isLow = percentage < 20;
            const safeHex = hex && hex.startsWith('#') ? hex : '#333333';
            
            const style = {
                background: `conic-gradient(${safeHex} ${percentage}%, #d1c4a0 ${percentage}% 100%)`,
                boxShadow: 'inset 0 0 0 4px rgba(0,0,0,0.1)'
            };

            return (
                <div className="relative w-16 h-16 rounded-full flex items-center justify-center border-4 border-[#603813] transition-all" style={style}>
                    <div className="absolute w-10 h-10 bg-[#fcf0c8] rounded-full flex flex-col items-center justify-center border-2 border-[#603813] z-10">
                        <span className={`font-term text-xs font-bold ${isLow ? 'text-[#e60012] animate-pulse' : 'text-[#603813]'}`}>
                            {percentage.toFixed(0)}%
                        </span>
                    </div>
                    {isLow && <div className="absolute -top-1 -right-1 bg-[#e60012] text-white rounded-full p-0.5 border border-white z-20 shadow-md"><Icons.AlertTriangle size={10} /></div>}
                </div>
            );
        };

        const BootScreen = ({ error, onRetry, onOffline }) => (
            <div className="min-h-screen bg-black text-[#00a800] font-term text-xl p-8 flex flex-col justify-center items-center">
                <div className="max-w-2xl w-full space-y-2 text-center">
                    <p className="text-[#f8d878] mb-4">333 PRINT QUEST</p>
                    <p>LOADING SYSTEM...</p>
                    <p>CONNECTING... <span className={error ? "text-[#e60012]" : "blink"}>{error ? "ERROR" : "_"}</span></p>
                    {error && (
                        <div className="border-2 border-[#e60012] p-4 mt-8 bg-[#200] text-[#e60012] animate-in fade-in text-left">
                            <div className="font-mono text-sm mb-4">{error}</div>
                            <div className="flex gap-4 justify-center">
                                <button onClick={onRetry} className="border-2 border-[#e60012] px-4 py-3 hover:bg-[#e60012] hover:text-white uppercase font-retro text-xs">Retry</button>
                                <button onClick={onOffline} className="border-2 border-gray-500 text-gray-400 px-4 py-3 hover:bg-gray-700 hover:text-white uppercase font-retro text-xs">Offline</button>
                            </div>
                        </div>
                    )}
                </div>
            </div>
        );

        // --- ABA: ESTOQUE (2 Colunas, Compacto, Zelda Colors) ---
        const StockManager = ({ db, onUpdateStock }) => {
            const [editingId, setEditingId] = useState(null);
            const [formData, setFormData] = useState({});
            const [isNew, setIsNew] = useState(false);
            const [saving, setSaving] = useState(false);
            const [deletingId, setDeletingId] = useState(null);

            const materials = db.materiais || [];

            const handleEdit = (mat) => {
                setFormData({
                    id: mat.id,
                    marca: getStringVal(mat, ['marca']),
                    tipo: getStringVal(mat, ['tipo']),
                    cor: getStringVal(mat, ['cor']),
                    hex: getStringVal(mat, ['hex']) || '#000000',
                    peso_inicial: getMoneyVal(mat, ['pesoinicial', 'peso_inicial', 'peso_inicial_g']),
                    peso_atual: getMoneyVal(mat, ['pesoatual', 'peso_atual', 'peso_atual_g']),
                    preco: getMoneyVal(mat, ['precokg', 'preco_kg', 'preco'])
                });
                setEditingId(mat.id);
                setIsNew(false);
            };

            const handleNew = () => {
                setFormData({ marca: "", tipo: "PLA", cor: "", hex: "#000000", peso_inicial: 1000, peso_atual: 1000, preco: 0 });
                setEditingId("NEW");
                setIsNew(true);
            };

            const handleSave = async () => {
                setSaving(true);
                const action = isNew ? "novo_material" : "editar_material";
                await onUpdateStock({ ...formData, action });
                setSaving(false);
                setEditingId(null);
            };

            const handleDelete = async (id) => {
                if(!confirm("Tem certeza que quer remover este filamento?")) return;
                setDeletingId(id);
                await onUpdateStock({ action: "deletar_material", id }, 3000); 
                setDeletingId(null);
            };

            return (
                <div className="animate-in fade-in">
                    <div className="flex justify-end mb-4">
                        <button onClick={handleNew} className="retro-btn btn-blue px-4 py-2 font-retro text-xs flex gap-2 items-center">
                            <Icons.PlusCircle size={16}/> NOVO
                        </button>
                    </div>

                    {editingId && (
                        <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4">
                            <div className="retro-box w-full max-w-lg p-6 relative">
                                <button onClick={() => setEditingId(null)} className="absolute top-2 right-2 text-gray-500 hover:text-[#e60012]"><Icons.X /></button>
                                <h2 className="font-retro text-sm text-[#603813] mb-4 border-b-2 border-[#603813] pb-2">
                                    {isNew ? "CRAFT NEW ITEM" : "MODIFY ITEM"}
                                </h2>
                                <div className="grid grid-cols-2 gap-4 mb-4">
                                    <div><label className="font-term text-gray-500">Marca</label><input className="retro-input w-full" value={formData.marca} onChange={e => setFormData({...formData, marca: e.target.value})} /></div>
                                    <div><label className="font-term text-gray-500">Tipo</label><input className="retro-input w-full" value={formData.tipo} onChange={e => setFormData({...formData, tipo: e.target.value})} /></div>
                                </div>
                                <div className="grid grid-cols-2 gap-4 mb-4">
                                    <div><label className="font-term text-gray-500">Cor</label><input className="retro-input w-full" value={formData.cor} onChange={e => setFormData({...formData, cor: e.target.value})} /></div>
                                    <div>
                                        <label className="font-term text-gray-500 flex items-center gap-2">Hex <div className="w-4 h-4 border border-black" style={{background: formData.hex}}></div></label>
                                        <div className="flex gap-2">
                                            <input type="color" className="w-8 h-8 border-2 border-black p-0 cursor-pointer" value={formData.hex} onChange={e => setFormData({...formData, hex: e.target.value})} />
                                            <input className="retro-input flex-1 uppercase" value={formData.hex} onChange={e => setFormData({...formData, hex: e.target.value})} />
                                        </div>
                                    </div>
                                </div>
                                <div className="grid grid-cols-3 gap-4 mb-6">
                                    <div><label className="font-term text-gray-500">Total (g)</label><input type="number" className="retro-input w-full text-right" value={formData.peso_inicial} onChange={e => setFormData({...formData, peso_inicial: Number(e.target.value)})} /></div>
                                    <div><label className="font-term text-gray-500">Atual (g)</label><input type="number" className="retro-input w-full text-right" value={formData.peso_atual} onChange={e => setFormData({...formData, peso_atual: Number(e.target.value)})} /></div>
                                    <div><label className="font-term text-gray-500">R$/Kg</label><input type="number" className="retro-input w-full text-right" value={formData.preco} onChange={e => setFormData({...formData, preco: Number(e.target.value)})} /></div>
                                </div>
                                <button onClick={handleSave} disabled={saving} className="w-full retro-btn btn-green py-3 font-retro text-xs flex justify-center gap-2">
                                    {saving ? "SAVING..." : "SAVE GAME"}
                                </button>
                            </div>
                        </div>
                    )}

                    <div className="grid grid-cols-2 gap-3">
                        {materials.map(mat => {
                            const total = getMoneyVal(mat, ['pesoinicial', 'peso_inicial', 'peso_inicial_g']);
                            const current = getMoneyVal(mat, ['pesoatual', 'peso_atual', 'peso_atual_g']);
                            const hex = getStringVal(mat, ['hex']);
                            const isDeleting = deletingId === mat.id;
                            
                            return (
                                <div key={mat.id} className={`retro-box p-2 relative flex flex-col items-center text-center transition-opacity ${isDeleting ? 'opacity-50' : ''}`}>
                                    
                                    {/* Action Buttons Top-Right */}
                                    <div className="absolute top-1 right-1 flex gap-1 z-10">
                                        <button onClick={() => handleEdit(mat)} className="text-gray-400 hover:text-blue-600 p-0.5"><Icons.Edit3 size={14}/></button>
                                        <button onClick={() => handleDelete(mat.id)} className="text-gray-400 hover:text-[#e60012] p-0.5"><Icons.Trash2 size={14}/></button>
                                    </div>

                                    {/* Gauge */}
                                    <div className="mt-2 mb-2">
                                        <SpoolGauge hex={hex} current={current} total={total} />
                                    </div>
                                    
                                    {/* Info - Sem borda extra, apenas texto */}
                                    <div className="w-full space-y-0.5">
                                        <div className="flex justify-center gap-1 flex-wrap">
                                            <span className="font-retro text-[8px] bg-[#d1c4a0] px-1 rounded text-[#603813] truncate max-w-full uppercase">{getStringVal(mat, ['marca'])}</span>
                                            <span className="font-retro text-[8px] border border-[#603813] px-1 rounded text-[#603813] uppercase">{getStringVal(mat, ['tipo'])}</span>
                                        </div>
                                        <div className="font-bold text-[#603813] text-xs truncate w-full px-1">{getStringVal(mat, ['cor'])}</div>
                                        <div className="font-term text-gray-500 text-xs">
                                            {current}g
                                        </div>
                                    </div>
                                </div>
                            )
                        })}
                    </div>
                </div>
            );
        };

        // --- ABA: CALCULADORA ---
        const CalculadoraMaster = ({ db, offlineMode, onSaveSale }) => {
            const [step, setStep] = useState(1);
            const [saving, setSaving] = useState(false);
            const [productName, setProductName] = useState("");
            
            const [inputs, setInputs] = useState({
                maquinaId: db.maquinas?.[0]?.id || '',
                materialId: db.materiais?.[0]?.id || '',
                pesoPeca: 120, pesoSuporte: 20, tempoPrint: 4.5,
                tempoSetup: 15, tempoPos: 20,
                insumoId: db.insumos?.[0]?.id || '', embalagemId: '',
                marketplaceId: db.marketplaces?.[0]?.id || '',
                margemLucro: 30, custoFrete: 0, investimentoMkt: 5.00
            });

            if (!db.maquinas || !db.maquinas.length) return <div className="text-[#e60012] font-term bg-[#fcf0c8] p-4 border-2 border-[#e60012]">ERRO: DB VAZIO. VERIFIQUE A PLANILHA.</div>;

            const getVal = (obj, keys, def = 0) => getMoneyVal(obj, keys) || def;

            const maq = db.maquinas.find(m => m.id === inputs.maquinaId) || db.maquinas[0];
            const mat = db.materiais.find(m => m.id === inputs.materialId) || db.materiais[0];
            const mkt = db.marketplaces.find(m => m.id === inputs.marketplaceId) || db.marketplaces[0];
            const insumo = db.insumos?.find(i => i.id === inputs.insumoId);
            const emb = db.insumos?.find(i => i.id === inputs.embalagemId);

            const config = {
                custoFixo: getVal(db.config, ['custos_fixos_mensais']),
                horasMes: getVal(db.config, ['horas_operacionais_mes']),
                kwh: getVal(db.config, ['custo_kwh']),
                falha: getVal(db.config, ['taxa_falha_media']),
                horaHumana: getVal(db.config, ['custo_hora_humana'])
            };

            const pesoTotal = inputs.pesoPeca + inputs.pesoSuporte;
            const custoFilamento = (pesoTotal / 1000) * getVal(mat, ['precokg', 'preco_kg', 'preco']);
            const custoFalha = custoFilamento * config.falha;
            
            const custoEnergia = inputs.tempoPrint * (getVal(maq, ['potencia_w', 'potencia']) / 1000) * config.kwh;
            const custoDeprec = (getVal(maq, ['preco_compra', 'preco']) / getVal(maq, ['vida_util_h', 'vidah'], 5000)) * inputs.tempoPrint;
            const custoManut = (getVal(maq, ['custo_manutencao_ano', 'manutano'], 100) / (config.horasMes * 12)) * inputs.tempoPrint;
            const custoMaquina = custoEnergia + custoDeprec + custoManut;

            const custoMaoObra = ((inputs.tempoSetup + inputs.tempoPos) / 60) * config.horaHumana;
            const custoFixoRateio = (config.custoFixo / config.horasMes) * inputs.tempoPrint;
            const custoInsumos = (insumo ? getVal(insumo, ['custo_unit', 'custo']) : 0) + (emb ? getVal(emb, ['custo_unit', 'custo']) : 0);

            const custoProducao = custoFilamento + custoFalha + custoMaquina + custoMaoObra + custoFixoRateio + custoInsumos;

            let comissao = getVal(mkt, ['comissao']); if (comissao > 1) comissao /= 100;
            let imposto = getVal(mkt, ['imposto_nota', 'imposto']); if (imposto > 1) imposto /= 100;
            const taxaFixa = getVal(mkt, ['taxa_fixa_r$', 'taxafixa']);
            const margem = inputs.margemLucro / 100;
            
            const denominador = 1 - (comissao + imposto + margem);
            const custosVendaFixos = taxaFixa + inputs.custoFrete + inputs.investimentoMkt;
            const precoVenda = denominador > 0 ? (custoProducao + custosVendaFixos) / denominador : 0;
            const lucroLiquido = precoVenda - (custoProducao + custosVendaFixos + (precoVenda * comissao) + (precoVenda * imposto));

            const handleSave = async () => {
                if (!productName) return alert("Nome do produto obrigat√≥rio!");
                setSaving(true);
                await onSaveSale({
                    action: "nova_venda",
                    produto: productName,
                    material: `${getStringVal(mat, ['marca'])} ${getStringVal(mat, ['tipo'])}`,
                    materialId: mat.id, 
                    peso: pesoTotal,
                    custo: custoProducao,
                    venda: precoVenda,
                    lucro: lucroLiquido,
                    canal: getStringVal(mkt, ['nome'])
                });
                setSaving(false);
                setProductName("");
            };

            return (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 animate-in fade-in">
                    <div>
                        <RetroCard title="CRAFTING PARAMS" icon={<Icons.Settings size={16}/>}>
                            <div className="flex border-b-2 border-black/10 mb-4 pb-2 gap-4">
                                {[1, 2, 3].map(s => <button key={s} onClick={() => setStep(s)} className={`font-retro text-xs ${step===s ? 'text-[#603813] underline' : 'text-gray-400'}`}>STAGE {s}</button>)}
                            </div>
                            {step === 1 && (
                                <div className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="block font-term text-gray-500">M√°quina</label><select className="retro-input w-full" value={inputs.maquinaId} onChange={e => setInputs({...inputs, maquinaId: e.target.value})}>{db.maquinas.map(m => <option key={m.id} value={m.id}>{m.nome}</option>)}</select></div>
                                        <div><label className="block font-term text-gray-500">Material</label><select className="retro-input w-full" value={inputs.materialId} onChange={e => setInputs({...inputs, materialId: e.target.value})}>{db.materiais.map(m => <option key={m.id} value={m.id}>{getStringVal(m, ['marca'])} {getStringVal(m, ['tipo'])} ({getStringVal(m, ['cor'])})</option>)}</select></div>
                                    </div>
                                    <div className="grid grid-cols-3 gap-4">
                                        <div><label className="block font-term text-gray-500">Pe√ßa (g)</label><input type="number" className="retro-input w-full text-right" value={inputs.pesoPeca} onChange={e => setInputs({...inputs, pesoPeca: Number(e.target.value)})} /></div>
                                        <div><label className="block font-term text-gray-500">Suporte</label><input type="number" className="retro-input w-full text-right text-red-600" value={inputs.pesoSuporte} onChange={e => setInputs({...inputs, pesoSuporte: Number(e.target.value)})} /></div>
                                        <div><label className="block font-term text-gray-500">Tempo (h)</label><input type="number" className="retro-input w-full text-right" value={inputs.tempoPrint} onChange={e => setInputs({...inputs, tempoPrint: Number(e.target.value)})} /></div>
                                    </div>
                                </div>
                            )}
                            {step === 2 && (
                                <div className="space-y-4">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="block font-term text-gray-500">Setup (min)</label><input type="number" className="retro-input w-full text-right" value={inputs.tempoSetup} onChange={e => setInputs({...inputs, tempoSetup: Number(e.target.value)})} /></div>
                                        <div><label className="block font-term text-gray-500">P√≥s (min)</label><input type="number" className="retro-input w-full text-right" value={inputs.tempoPos} onChange={e => setInputs({...inputs, tempoPos: Number(e.target.value)})} /></div>
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="block font-term text-gray-500">Insumo</label><select className="retro-input w-full" value={inputs.insumoId} onChange={e => setInputs({...inputs, insumoId: e.target.value})}><option value="">Nenhum</option>{db.insumos?.map(i => <option key={i.id} value={i.id}>{i.item}</option>)}</select></div>
                                        <div><label className="block font-term text-gray-500">Embalagem</label><select className="retro-input w-full" value={inputs.embalagemId} onChange={e => setInputs({...inputs, embalagemId: e.target.value})}><option value="">Nenhum</option>{db.insumos?.map(i => <option key={i.id} value={i.id}>{i.item}</option>)}</select></div>
                                    </div>
                                </div>
                            )}
                            {step === 3 && (
                                <div className="space-y-4">
                                    <div><label className="block font-term text-gray-500">Canal</label><select className="retro-input w-full" value={inputs.marketplaceId} onChange={e => setInputs({...inputs, marketplaceId: e.target.value})}>{db.marketplaces?.map(m => <option key={m.id} value={m.id}>{m.nome}</option>)}</select></div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div><label className="block font-term text-blue-600">Margem %</label><input type="number" className="retro-input w-full text-right text-blue-800 font-bold" value={inputs.margemLucro} onChange={e => setInputs({...inputs, margemLucro: Number(e.target.value)})} /></div>
                                        <div><label className="block font-term text-gray-500">Mkt (R$)</label><input type="number" className="retro-input w-full text-right" value={inputs.investimentoMkt} onChange={e => setInputs({...inputs, investimentoMkt: Number(e.target.value)})} /></div>
                                    </div>
                                </div>
                            )}
                        </RetroCard>
                    </div>

                    <div>
                        <RetroCard title="ORACLE PREDICTION" icon={<Icons.Scroll size={16}/>} color="border-[#603813]">
                            <div className="bg-white p-4 font-term text-lg border-2 border-dashed border-gray-400 relative">
                                <div className="flex justify-between font-bold border-b border-black mb-2"><span>COST</span> <span>R$ {custoProducao.toFixed(2)}</span></div>
                                <div className="flex justify-between font-bold border-b border-black mb-4"><span>TAX</span> <span>R$ {(precoVenda - custoProducao - lucroLiquido).toFixed(2)}</span></div>
                                <div className="flex justify-between items-center text-[#00a800]">
                                    <span className="font-retro text-xs">PROFIT</span><span className="text-2xl font-bold">R$ {lucroLiquido.toFixed(2)}</span>
                                </div>
                                <div className="flex justify-between items-center mt-2 text-blue-700">
                                    <span className="font-retro text-xs">SELL</span><span className="text-3xl font-bold underline">R$ {precoVenda.toFixed(2)}</span>
                                </div>
                            </div>
                            
                            <div className="mt-4 space-y-2">
                                <input type="text" placeholder="Nome do Produto (ex: Master Sword)" className="retro-input w-full mb-2" value={productName} onChange={e => setProductName(e.target.value)} />
                                <button onClick={handleSave} disabled={saving || offlineMode} className={`w-full retro-btn py-3 font-retro text-xs text-white flex items-center justify-center gap-2 ${saving ? 'bg-gray-500' : 'btn-green'}`}>
                                    {saving ? "SAVING..." : "REGISTER SALE"}
                                </button>
                            </div>
                        </RetroCard>
                    </div>
                </div>
            );
        };

        // --- ABA: GASTOS ---
        const GastosManager = ({ db, onSaveExpense }) => {
            const [item, setItem] = useState("");
            const [valor, setValor] = useState("");
            const [cat, setCat] = useState("MATERIA_PRIMA");
            const [saving, setSaving] = useState(false);

            const handleSave = async () => {
                if (!item || !valor) return alert("Preencha item e valor");
                setSaving(true);
                await onSaveExpense({ action: "novo_gasto", item, categoria: cat, valor: Number(valor) });
                setSaving(false); setItem(""); setValor("");
            };

            return (
                <div className="animate-in fade-in">
                    <RetroCard title="NEW LOOT" icon={<Icons.Package size={16}/>} color="border-[#603813]">
                        <div className="flex flex-col md:flex-row gap-4 items-end">
                            <div className="flex-1 w-full"><label className="font-term text-gray-500">Item</label><input className="retro-input w-full" value={item} onChange={e => setItem(e.target.value)} placeholder="Ex: Potion" /></div>
                            <div className="w-full md:w-32"><label className="font-term text-gray-500">Valor (R$)</label><input type="number" className="retro-input w-full" value={valor} onChange={e => setValor(e.target.value)} placeholder="0.00" /></div>
                            <div className="w-full md:w-48"><label className="font-term text-gray-500">Categoria</label><select className="retro-input w-full" value={cat} onChange={e => setCat(e.target.value)}><option value="MATERIA_PRIMA">Mat√©ria Prima</option><option value="MANUTENCAO">Manuten√ß√£o</option><option value="FERRAMENTA">Ferramenta</option><option value="FIXO">Custo Fixo</option></select></div>
                            <button onClick={handleSave} disabled={saving} className="retro-btn btn-red p-3 md:w-auto w-full flex justify-center">{saving ? "..." : <Icons.PlusCircle />}</button>
                        </div>
                    </RetroCard>
                    <RetroCard title="QUEST LOG" icon={<Icons.Scroll size={16}/>}>
                        <table className="w-full font-term text-lg text-left">
                            <thead className="border-b-2 border-black"><tr><th className="p-2">DATA</th><th className="p-2">ITEM</th><th className="p-2 text-right">VALOR</th></tr></thead>
                            <tbody>
                                {db.historico_gastos?.map((g, i) => (
                                    <tr key={i} className="border-b border-gray-300">
                                        <td className="p-2 text-gray-500">{new Date(g.data).toLocaleDateString()}</td><td className="p-2">{g.item}</td><td className="p-2 text-right text-[#e60012]">- R$ {getMoneyVal(g, ['valor']).toFixed(2)}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </RetroCard>
                </div>
            );
        };

        // --- ABA: VENDAS ---
        const SalesManager = ({ db }) => {
            const sales = db.historico_vendas || [];
            const totalRevenue = sales.reduce((acc, curr) => acc + getMoneyVal(curr, ['venda', 'vendafinal']), 0);
            const totalProfit = sales.reduce((acc, curr) => acc + getMoneyVal(curr, ['lucro', 'lucroreal']), 0);

            return (
                <div className="animate-in fade-in">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <RetroCard title="RUPEES GAINED" icon={<Icons.Coins size={16}/>}><div className="text-center py-2"><span className="font-term text-4xl text-[#00a800]">R$ {totalRevenue.toFixed(2)}</span></div></RetroCard>
                        <RetroCard title="NET PROFIT" icon={<Icons.TrendingUp size={16}/>}><div className="text-center py-2"><span className="font-term text-4xl text-[#0078d7]">R$ {totalProfit.toFixed(2)}</span></div></RetroCard>
                    </div>
                    <RetroCard title="ADVENTURE LOG" icon={<Icons.Scroll size={16}/>}>
                        <div className="overflow-x-auto">
                            <table className="w-full font-term text-lg text-left">
                                <thead className="border-b-2 border-black bg-[#d1c4a0]"><tr><th className="p-3"><Icons.Calendar size={14}/> DATA</th><th className="p-3">ITEM</th><th className="p-3">PLACE</th><th className="p-3 text-right">GOLD</th><th className="p-3 text-right">GAIN</th></tr></thead>
                                <tbody>
                                    {sales.map((v, i) => (
                                        <tr key={i} className="border-b border-gray-300 hover:bg-white transition-colors"><td className="p-3 text-gray-500 text-sm">{new Date(v.data).toLocaleDateString()}</td><td className="p-3 font-bold text-gray-800">{v.produto}</td><td className="p-3"><span className="text-[10px] bg-gray-200 px-2 py-1 rounded font-retro text-gray-600">{v.canal}</span></td><td className="p-3 text-right text-[#00a800] font-bold">R$ {getMoneyVal(v, ['venda', 'vendafinal']).toFixed(2)}</td><td className="p-3 text-right text-blue-600">R$ {getMoneyVal(v, ['lucro', 'lucroreal']).toFixed(2)}</td></tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </RetroCard>
                </div>
            );
        };

        // --- APP ROOT ---
        const PrintQuestOS = () => {
            const [activeTab, setActiveTab] = useState('calc');
            const [db, setDb] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [offlineMode, setOfflineMode] = useState(false);
            const [toast, setToast] = useState(null);
            const [isMenuOpen, setIsMenuOpen] = useState(false);

            const fetchData = async () => {
                try {
                    const res = await fetch(API_URL, { method: "GET", credentials: "omit" });
                    if (!res.ok) throw new Error("Connection failed");
                    const data = await res.json();
                    setDb(data); setLoading(false);
                } catch (err) {
                    console.error(err);
                    setToast({type: 'error', msg: "Connection Lost. Offline Mode."});
                    setDb(DB_OFFLINE); setOfflineMode(true); setLoading(false);
                }
            };

            useEffect(() => { fetchData(); }, []);

            const sendData = async (payload, delay = 3000) => {
                try {
                    await fetch(API_URL, { method: "POST", mode: "no-cors", headers: { "Content-Type": "text/plain" }, body: JSON.stringify(payload) });
                    setToast({type: 'success', msg: "Game Saved!"});
                    setTimeout(fetchData, delay);
                } catch (e) {
                    setToast({type: 'error', msg: "Save Failed!"});
                }
            };

            useEffect(() => { if (toast) setTimeout(() => setToast(null), 4000); }, [toast]);

            if (loading && !db) return <BootScreen error={error} onRetry={() => window.location.reload()} onOffline={() => {setDb(DB_OFFLINE); setOfflineMode(true); setLoading(false);}} />;

            const tabs = [
                { id: 'calc', label: 'CRAFT', icon: <Icons.Hammer size={14}/>, color: 'btn-gold' },
                { id: 'estoque', label: 'STOCK', icon: <Icons.Droplet size={14}/>, color: 'btn-blue' },
                { id: 'vendas', label: 'SALES', icon: <Icons.Coins size={14}/>, color: 'btn-green' },
                { id: 'gastos', label: 'LOOT', icon: <Icons.Package size={14}/>, color: 'btn-red' },
            ];

            return (
                <div className="min-h-screen pb-12">
                    {toast && <div className={`fixed top-20 right-4 z-50 px-4 py-3 rounded shadow-lg border-2 border-black font-term flex items-center gap-2 animate-in slide-in-from-right ${toast.type === 'error' ? 'btn-red' : 'btn-green'}`}>{toast.type === 'error' ? "‚ö†Ô∏è" : "üíæ"} {toast.msg}</div>}
                    
                    <header className={`bg-[#1f2416] border-b-4 border-[#f8d878] sticky top-0 z-50 shadow-lg`}>
                        <div className="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center relative">
                            {/* LOGO */}
                            <div className="flex items-center gap-3">
                                <div className={`${offlineMode ? 'text-gray-500' : 'text-[#f8d878]'} drop-shadow-md`}>
                                    <Icons.Sword size={40} />
                                </div>
                                <div>
                                    <h1 className="font-retro text-[#f8d878] text-xs md:text-lg tracking-widest drop-shadow-md">333 PRINT QUEST</h1>
                                    <div className="flex items-center gap-2">
                                        <div className={`w-2 h-2 rounded-full ${offlineMode ? 'bg-gray-500' : 'bg-[#00a800] animate-pulse'}`}></div>
                                        <p className={`font-term text-lg leading-none ${offlineMode ? 'text-gray-400' : 'text-[#00a800]'}`}>{offlineMode ? 'OFFLINE' : 'ONLINE'}</p>
                                    </div>
                                </div>
                            </div>

                            {/* DESKTOP NAV */}
                            <nav className="hidden md:flex gap-2">
                                {tabs.map(tab => (
                                    <button 
                                        key={tab.id}
                                        onClick={() => setActiveTab(tab.id)} 
                                        className={`retro-btn px-3 py-2 font-retro text-xs flex gap-2 ${activeTab === tab.id ? `${tab.color}` : 'bg-[#2c1a0b] text-[#fcf0c8] border-[#603813]'}`}
                                    >
                                        {tab.icon} {tab.label}
                                    </button>
                                ))}
                                <button onClick={() => window.location.reload()} className="retro-btn px-2 bg-[#2c1a0b] text-[#fcf0c8] border-[#603813]"><Icons.RefreshCw size={14}/></button>
                            </nav>

                            {/* MOBILE HAMBURGER */}
                            <button className="md:hidden text-[#f8d878]" onClick={() => setIsMenuOpen(!isMenuOpen)}>
                                {isMenuOpen ? <Icons.X size={32} /> : <Icons.Menu size={32} />}
                            </button>
                        </div>

                        {/* MOBILE MENU DROPDOWN */}
                        {isMenuOpen && (
                            <div className="md:hidden absolute w-full bg-[#1f2416] border-b-4 border-[#f8d878] z-50 animate-in slide-in-from-top duration-300 shadow-xl">
                                <div className="flex flex-col p-4 gap-3">
                                    {tabs.map(tab => (
                                        <button 
                                            key={tab.id}
                                            onClick={() => { setActiveTab(tab.id); setIsMenuOpen(false); }} 
                                            className={`retro-btn px-4 py-4 font-retro text-sm flex gap-3 justify-center ${activeTab === tab.id ? `${tab.color}` : 'bg-[#2c1a0b] text-[#fcf0c8] border-[#603813]'}`}
                                        >
                                            {tab.icon} {tab.label}
                                        </button>
                                    ))}
                                </div>
                            </div>
                        )}
                    </header>

                    <main className="max-w-6xl mx-auto px-4 py-8">
                        {activeTab === 'calc' && <CalculadoraMaster db={db} offlineMode={offlineMode} onSaveSale={sendData} />}
                        {activeTab === 'estoque' && <StockManager db={db} onUpdateStock={sendData} />}
                        {activeTab === 'vendas' && <SalesManager db={db} />}
                        {activeTab === 'gastos' && <GastosManager db={db} onSaveExpense={sendData} />}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<PrintQuestOS />);
    </script>
</body>
</html>
